---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';
import defaultThumbnail from '../asset/default.jpg';

type Props = CollectionEntry<'blog'>['data'] & { slug?: string };

const { title, description, pubDate, updatedDate, heroImage, category, tags, slug } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;
const siteURL = Astro.site || new URL(Astro.url.pathname, Astro.url.origin);
const canonicalURL = new URL(`/blog/${slug}/`, siteURL);
const articleUrl = canonicalURL.toString();
const publishedTime = pubDate.toISOString();
const modifiedTime = (updatedDate || pubDate).toISOString();

// 日付フォーマット（yyyy年mm月dd日 hh時mm分）
const formatDateTime = (date: Date) => {
	const year = date.getFullYear();
	const month = date.getMonth() + 1;
	const day = date.getDate();
	const hours = date.getHours();
	const minutes = date.getMinutes();
	return `${year}年${month}月${day}日 ${hours.toString().padStart(2, '0')}時${minutes.toString().padStart(2, '0')}分`;
};

const formattedPubDate = formatDateTime(pubDate);
const formattedUpdatedDate = updatedDate ? formatDateTime(updatedDate) : null;

const getUrl = (path: string) => {
	if (path.startsWith('/')) {
		return `${baseUrl}${baseUrl.endsWith('/') ? path.slice(1) : path}`;
	}
	return path;
};

// 構造化データ（JSON-LD）
const structuredData = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	headline: title,
	description: description,
	image: heroImage ? new URL(heroImage.src, siteURL).toString() : undefined,
	datePublished: publishedTime,
	dateModified: modifiedTime,
	author: {
		'@type': 'Person',
		name: SITE_TITLE,
	},
	publisher: {
		'@type': 'Organization',
		name: SITE_TITLE,
	},
	mainEntityOfPage: {
		'@type': 'WebPage',
		'@id': articleUrl,
	},
	articleSection: category,
	keywords: tags?.join(', ') || '',
};
---

<html lang="ja">
	<head>
		<BaseHead title={`${title} | ブログ | ${SITE_TITLE}`} description={description} />
		<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
		<link rel="canonical" href={canonicalURL} />
		<style is:global>
			main {
				max-width: 800px;
				margin: 0 auto;
				padding: 2em 1em;
			}
			
			.hero-image {
				position: relative;
				width: 100%;
				margin-bottom: 2em;
			}
			
			.hero-image img {
				display: block;
				width: 100%;
				height: auto;
				margin: 0 auto;
				/* border-radius: var(--border-radius); */
				box-shadow: var(--box-shadow);
			}
			
			.hero-category {
				position: absolute;
				top: 0;
				right: 1em;
				z-index: 10;
			}
			
			.prose {
				max-width: 100%;
				margin: 0 auto;
			}
			
			/* 記事本文内の見出しスタイル - シンプルモダンなメインカラー装飾 */
			article .prose h2 {
				margin-top: 2.5em !important;
				margin-bottom: 1em !important;
				padding-bottom: 0.5em !important;
				border-bottom: 2px solid var(--accent) !important;
				font-size: 1.75em !important;
				font-weight: 600 !important;
				color: rgb(var(--black)) !important;
				line-height: 1.4 !important;
			}
			
			article .prose h3 {
				margin-top: 2em !important;
				margin-bottom: 0.75em !important;
				padding-left: 0.75em !important;
				border-left: 3px solid var(--accent) !important;
				font-size: 1.4em !important;
				font-weight: 600 !important;
				color: rgb(var(--black)) !important;
				line-height: 1.4 !important;
			}
			
			article .prose h4 {
				margin-top: 1.5em !important;
				margin-bottom: 0.5em !important;
				padding-left: 0.5em !important;
				border-left: 2px solid var(--accent) !important;
				font-size: 1.2em !important;
				font-weight: 600 !important;
				color: var(--accent) !important;
				line-height: 1.4 !important;
			}
			
			article .prose h5 {
				margin-top: 1.25em !important;
				margin-bottom: 0.5em !important;
				font-size: 1.1em !important;
				font-weight: 600 !important;
				color: var(--accent) !important;
			}
			
			article .prose h6 {
				margin-top: 1em !important;
				margin-bottom: 0.5em !important;
				font-size: 1em !important;
				font-weight: 600 !important;
				color: var(--accent-dark) !important;
			}
			
			.article-header {
				margin-bottom: 2.5em;
			}
			
			.article-title {
				margin: 0 0 0.75em 0;
				font-size: 2.25em;
				font-weight: 600;
				line-height: 1.3;
				color: rgb(var(--black));
			}
			
			.article-date {
				/* margin-bottom: 1.25em; */
				color: rgb(var(--gray));
				font-size: 0.9em;
			}
			
			.article-meta {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5em;
				align-items: center;
				margin-bottom: 2em;
				padding-bottom: 1.5em;
				border-bottom: 1px solid rgb(var(--gray-light));
			}
			
			.category-link {
				display: inline-block;
				padding: 0.3em 0.8em;
				background: var(--accent-light);
				color: var(--accent-dark);
				text-decoration: none;
				font-size: 0.75em;
				font-weight: 500;
				transition: var(--transition);
			}
			
			.category-link:hover {
				background: var(--accent);
				color: white;
			}
			
			.tag-link {
				display: inline-block;
				color: var(--accent);
				text-decoration: none;
				font-size: 0.8em;
				font-weight: 400;
				transition: var(--transition);
			}
			
			.tag-link:hover {
				color: var(--accent-dark);
			}
			
			.tag-separator {
				display: none;
			}
			
			@media (max-width: 768px) {
				.article-title {
					font-size: 1.75em;
				}
				
				article .prose h2 {
					font-size: 1.5em !important;
					padding-bottom: 0.4em !important;
					margin-top: 2em !important;
				}
				
				article .prose h3 {
					font-size: 1.3em !important;
					padding-left: 0.6em !important;
					margin-top: 1.75em !important;
				}
				
				article .prose h4 {
					font-size: 1.15em !important;
					padding-left: 0.5em !important;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{category && (
						<div class="hero-category">
							<a href={getUrl(`/blog/category/${category}/`)} class="category-link">
								{category}
							</a>
						</div>
					)}
					<Image 
						width={1020} 
						height={510} 
						src={heroImage || defaultThumbnail} 
						alt={title} 
					/>
				</div>
				<div class="prose">
					<div class="article-header">
						<h1 class="article-title">{title}</h1>
						<div class="article-date">
							<time datetime={pubDate.toISOString()}>
								{formattedPubDate}
							</time>
							{updatedDate && formattedUpdatedDate && (
								<span style="margin-left: 0.75em; font-size: 0.9em; color: rgb(var(--gray));">
									更新: <time datetime={updatedDate.toISOString()}>{formattedUpdatedDate}</time>
								</span>
							)}
						</div>
						<div class="article-meta">
							{tags && tags.length > 0 && (
								<>
									{tags.map((tag, index) => (
										<>
											<a href={getUrl(`/blog/tag/${tag}/`)} class="tag-link">
												#{tag}
											</a>
											{index < tags.length - 1 && <span class="tag-separator">/</span>}
										</>
									))}
								</>
							)}
						</div>
					</div>
					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
